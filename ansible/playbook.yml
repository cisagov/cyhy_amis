---
- name: Setup the inventory and wait for a bastion to become available
  hosts: localhost
  gather_facts: yes
  check_mode: no
  tasks:
    - name: Add public ip addresses to an dynamic inventory
      ansible.builtin.add_host:
        name: "{{ host }}"
        groups: "{{ host_groups.split(',') }}"

    - name: Wait for the non-bastion instance to become available
      ansible.builtin.wait_for:
        port: 22
        host: "{{ host }}"
        search_regex: OpenSSH
      delegate_to: "{{ bastion_host }}"
      when: bastion_host is defined

    - name: Wait for the bastion instance to become available
      ansible.builtin.wait_for:
        port: 22
        host: "{{ host }}"
        search_regex: OpenSSH
      when: bastion_host is not defined

- name: Configure groups now that cloud-init has run
  hosts: all
  become: true
  become_method: ansible.builtin.sudo
  roles:
    - groups

- name: Configure MongoDB
  hosts: mongo
  become: true
  become_method: ansible.builtin.sudo
  roles:
    - mongo
    - mongo_logrotate
    - cyhy_feeds

- name: Configure Docker hosts for BOD 18-01 scanning and reporting
  hosts: bod_docker
  become: true
  become_method: ansible.builtin.sudo
  roles:
    - orchestrator
    - vdp_scanner
    - cyhy_mailer
    - code_gov_update

- name: Configure cyhy-commander hosts
  hosts: cyhy_commander
  become: true
  become_method: ansible.builtin.sudo
  roles:
    - cyhy_commander
    - role: swap
      vars:
        swap_swapfile_size: 2GiB
    - cyhy_logrotate

- name: Configure nmap scanning hosts
  hosts: nmap
  become: true
  become_method: ansible.builtin.sudo
  roles:
    - role: swap
      vars:
        swap_swapfile_size: 4GiB

- name: Configure cyhy-runner hosts
  hosts: cyhy_runner
  become: true
  become_method: ansible.builtin.sudo
  roles:
    - cyhy_logrotate

- name: Configure Nessus hosts
  hosts: nessus
  become: true
  become_method: ansible.builtin.sudo
  roles:
    - nessus

- name: Configure cyhy-reports hosts
  hosts: cyhy_reporter
  become: true
  become_method: ansible.builtin.sudo
  roles:
    - cyhy_reporter
    - cyhy_logrotate
    - cyhy_mailer

- name: Configure cyhy bastion hosts
  hosts: cyhy_bastion
  become: true
  become_method: ansible.builtin.sudo
  roles:
    - cyhy_ops

- name: Install and configure cyhy-dashboard
  hosts: cyhy_dashboard
  become: true
  become_method: ansible.builtin.sudo
  roles:
    - cyhy_dashboard

- name: Configure cyhy-archive hosts
  hosts: cyhy_archive
  become: true
  become_method: ansible.builtin.sudo
  roles:
    - cyhy_archive

- name: Configure management bastion hosts
  hosts: mgmt_bastion
  become: true
  become_method: ansible.builtin.sudo
  roles:
    - mgmt_ops
