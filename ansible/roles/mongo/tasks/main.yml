---
- name: Get service information
  ansible.builtin.service_facts:

- name: Determine if cyhy-commander needs to be stopped
  ansible.builtin.set_fact:
    mongo_stop_commander: "{{ 'cyhy-commander' in ansible_facts.services and ansible_facts.services['cyhy-commander'].state != 'stopped' }}"

# This role will restart MongoDB no matter what which will make the
# cyhy-commander unhappy if it is running
- name: Stop the cyhy-commander service
  ansible.builtin.service:
    name: cyhy-commander
    state: stopped
  when: mongo_stop_commander

- name: Check if any mongo users already exist
  ansible.builtin.command: mongo --eval 'db.getUsers()' admin
  # This is a read-only operation
  changed_when: false
  ignore_errors: true
  register: mongo_check_for_mongo_users

# Ensure PyMongo is available for the community.mongodb collection's modules.
# The 3.12.3 version is the last of the PyMongo 3.x versions being tested. If
# the version pin for the community.mongodb collection is updated to 1.4.0-1.5.1
# we will need to pin to this version specifically due to how the collection
# checks the version of PyMongo available. Note that this may negatively impact
# other Python 3 packages that require newer versions of PyMongo.
- name: Install PyMongo
  ansible.builtin.pip:
    executable: /usr/bin/pip3
    name: pymongo
    version: '>=3.12.3'

- name: Create admin user in admin db (first user, no authentication)
  community.mongodb.mongodb_user:
    database: "{{ mongo_admin_db }}"
    name: "{{ mongo_admin_user }}"
    password: "{{ mongo_admin_pw }}"
    roles: "{{ mongo_admin_roles }}"
    state: present
  when: mongo_check_for_mongo_users.rc == 0

- name: Update admin user in admin db (authenticate as admin)
  community.mongodb.mongodb_user:
    database: "{{ mongo_admin_db }}"
    login_database: "{{ mongo_admin_db }}"
    login_password: "{{ mongo_admin_old_pw }}"
    login_user: "{{ mongo_admin_user }}"
    name: "{{ mongo_admin_user }}"
    password: "{{ mongo_admin_pw }}"
    roles: "{{ mongo_admin_roles }}"
    state: present
  when: mongo_check_for_mongo_users.rc != 0

- name: Update other users (authenticate as admin)
  community.mongodb.mongodb_user:
    database: "{{ lookup('aws_ssm', '/cyhy/mongo/users/' + item + '/database') }}"
    login_database: "{{ mongo_admin_db }}"
    login_password: "{{ mongo_admin_pw }}"
    login_user: "{{ mongo_admin_user }}"
    name: "{{ lookup('aws_ssm', '/cyhy/mongo/users/' + item + '/user') }}"
    password: "{{ lookup('aws_ssm', '/cyhy/mongo/users/' + item + '/password') }}"
    roles: "{{ lookup('aws_ssm', '/cyhy/mongo/users/' + item + '/roles').split(',') }}"
    state: present
  # Loop over all the users *except* for admin
  loop: "{{ mongo_non_admin_users }}"
  # ansible-lint throws a no-log-password on this task likely because
  # it is a module that needs password information and we are using a
  # loop. I would rather default to disabling logging than possibly
  # miss an edge case like error output on task failure that would leak
  # password information by disabling the rule.
  no_log: true

- name: Copy mongo configuration file
  ansible.builtin.template:
    dest: /etc/mongod.conf
    mode: 0644
    src: mongod.conf

- name: Restart mongod service to use new configuration
  ansible.builtin.service:
    name: mongod
    state: restarted

# Since we would have stopped the cyhy-commander if it was running we need to
# start it back up.
- name: Start the cyhy-commander service
  ansible.builtin.service:
    name: cyhy-commander
    state: started
  when: mongo_stop_commander
